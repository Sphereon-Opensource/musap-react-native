project 'musap-react-native.xcodeproj'

require File.join(File.dirname(`node --print "require.resolve('react-native/package.json')"`), "scripts/react_native_pods")
require File.join(File.dirname(`node --print "require.resolve('@react-native-community/cli-platform-ios/package.json')"`), "native_modules")

platform :ios, '13.4'
prepare_react_native_project!

target 'musap-react-native' do
  config = use_native_modules!

  use_react_native!(
    :path => config[:reactNativePath],
    :hermes_enabled => false,
    :fabric_enabled => false,
  )

  post_install do |installer|
    react_native_post_install(installer)

    # This is necessary for Xcode 14, because it signs resource bundles by default
    # when building for devices.
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['CODE_SIGNING_ALLOWED'] = 'NO'
      end
    end

    installer.pods_project.targets.each do |target|
      if target.name == 'DoubleConversion'
        target.build_configurations.each do |config|
          config.build_settings['CONFIGURATION_BUILD_DIR'] = '${PODS_CONFIGURATION_BUILD_DIR}'
        end
      end
    end

    # Workaround for Xcode 12.5 and Apple Silicon (M1) issue
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['EXCLUDED_ARCHS[sdk=iphonesimulator*]'] = 'arm64'
      end
    end

    # Add Swift package dependencies
    installer.pods_project.root_object.known_regions = ['en']
    installer.pods_project.targets.each do |target|
      target.build_configurations.each do |config|
        config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '13.4'
      end
    end

    # Add MUSAP package only if not already present
    require 'xcodeproj'
    project_path = 'musap-react-native.xcodeproj'
    project = Xcodeproj::Project.open(project_path)

    # Check if the package is already added
    package_already_exists = project.root_object.package_references.any? do |package|
      package.repositoryURL == 'https://github.com/methics/musap-ios'
    end

    unless package_already_exists
      # Find the main target
      main_target = project.targets.find { |t| t.name == 'musap-react-native' }

      # Add the package dependency
      package_dependency = project.new(Xcodeproj::Project::Object::XCRemoteSwiftPackageReference)
      package_dependency.repositoryURL = 'https://github.com/methics/musap-ios'
      package_dependency.requirement = {
        'kind' => 'branch',
        'branch' => 'main'
      }

      project.root_object.package_references << package_dependency

      # Add the package product dependency to the target
      product_dependency = project.new(Xcodeproj::Project::Object::XCSwiftPackageProductDependency)
      product_dependency.product_name = 'musap-ios'
      product_dependency.package = package_dependency

      main_target.package_product_dependencies << product_dependency

      project.save
    end
    system('swift package resolve')
  end
end
